<!DOCTYPE html>
<html lang="en">
<head>
  // ...existing code...
</head>
<body>
  // ...existing code...

  <script>
    // ensure the server-side list is safely rendered as JS array
    const expenses = {{ expenses|tojson|safe }} || [];

    // use distinct variable name for total expense
    let income = 0, expenseTotal = 0;

    // handle either list/tuple rows or object rows and parse amounts as numbers
    expenses.forEach(e => {
      const isArray = Array.isArray(e);
      const type = isArray ? e[4] : (e.type || e[4]);
      const amount = parseFloat(isArray ? e[3] : (e.amount || e[3])) || 0;
      if (type === "Income") income += amount;
      else expenseTotal += amount;
    });

    // format values with two decimals
    document.getElementById("incomeValue").textContent = "₹" + income.toFixed(2);
    document.getElementById("expenseValue").textContent = "₹" + expenseTotal.toFixed(2);
    document.getElementById("balanceValue").textContent = "₹" + (income - expenseTotal).toFixed(2);

    const ctx = document.getElementById("expenseChart").getContext("2d");
    new Chart(ctx, {
      type: "doughnut",
      data: {
        labels: ["Income", "Expense"],
        datasets: [{
          data: [income, expenseTotal],
          backgroundColor: ["#4CAF50", "#FF5252"],
          borderWidth: 1
        }]
      },
      options: {
        plugins: {
          legend: { position: "bottom" },
          title: { display: true, text: "Income vs Expense" }
        }
      }
    });
  </script>
</body>
</html>